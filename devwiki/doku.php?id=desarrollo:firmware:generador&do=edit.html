<!DOCTYPE html>
<html lang="es" dir="ltr" class="no-js">
<head>
    <meta charset="utf-8" />
    <title>desarrollo:firmware:generador []</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki"/>
<meta name="theme-color" content="#008800"/>
<meta name="robots" content="noindex,nofollow"/>
<link rel="search" type="application/opensearchdescription+xml" href="lib/exe/opensearch.php" title=""/>
<link rel="start" href="index.html"/>
<link rel="contents" href="./doku.php%3Fid=desarrollo:firmware:generador&amp;do=index.html" title="Índice"/>
<link rel="manifest" href="lib/exe/manifest.php"/>
<link rel="alternate" type="application/rss+xml" title="Cambios recientes" href="feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Espacio de nombres actual" href="./feed.php%3Fmode=list&amp;ns=desarrollo:firmware"/>
<link rel="alternate" type="text/html" title="HTML sencillo" href="./doku.php%3Fdo=export_xhtml&amp;id=desarrollo:firmware:generador.html"/>
<link rel="alternate" type="text/plain" title="Etiquetado Wiki" href="./doku.php%3Fdo=export_raw&amp;id=desarrollo:firmware:generador"/>
<link rel="stylesheet" href="lib/exe/css.php%3Ft=dokuwiki&amp;tseed=48a4f103b3dd9c0f0740691fb104868a.css"/>
<!--[if gte IE 9]><!-->
<script >/*<![CDATA[*/var NS='desarrollo:firmware';var JSINFO = {"id":"desarrollo:firmware:generador","namespace":"desarrollo:firmware","ACT":"source","useHeadingNavigation":0,"useHeadingContent":0};
/*!]]>*/</script>
<script src="lib/exe/jquery.php%3Ftseed=34a552433bc33cc9c3bc32527289a0b2"></script>
<script src="lib/exe/js.php%3Ft=dokuwiki&amp;tseed=48a4f103b3dd9c0f0740691fb104868a"></script>
<!--<![endif]-->
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="lib/tpl/dokuwiki/images/favicon.ico" />
<link rel="apple-touch-icon" href="lib/tpl/dokuwiki/images/apple-touch-icon.png" />
    </head>

<body>
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_source tpl_dokuwiki     hasSidebar">

        
<!-- ********** HEADER ********** -->
<header id="dokuwiki__header"><div class="pad group">

    
    <div class="headings group">
        <ul class="a11y skip">
            <li><a href="./doku.php%3Fid=desarrollo:firmware:generador&amp;do=edit.html#dokuwiki__content">Saltar a contenido</a></li>
        </ul>

        <h1 class="logo"><a href="index.html"  accesskey="h" title="Home [h]"><img src="lib/exe/fetch.php%3Fmedia=logo.png" width="461" height="91" alt="" /> <span></span></a></h1>
            </div>

    <div class="tools group">
        <!-- USER TOOLS -->
                    <div id="dokuwiki__usertools">
                <h3 class="a11y">Herramientas de usuario</h3>
                <ul>
                    <li class="action login"><a href="./doku.php%3Fid=desarrollo:firmware:generador&amp;do=login&amp;sectok=.html" title="Conectarse" rel="nofollow"><span>Conectarse</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M10 17.25V14H3v-4h7V6.75L15.25 12 10 17.25M8 2h9a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-4h2v4h9V4H8v4H6V4a2 2 0 0 1 2-2z"/></svg></a></li>                </ul>
            </div>
        
        <!-- SITE TOOLS -->
        <div id="dokuwiki__sitetools">
            <h3 class="a11y">Herramientas del sitio</h3>
            <form action="index.html" method="get" role="search" class="search doku_form" id="dw__search" accept-charset="utf-8"><input type="hidden" name="do" value="search" /><input type="hidden" name="id" value="desarrollo:firmware:generador" /><div class="no"><input name="q" type="text" class="edit" title="[F]" accesskey="f" placeholder="Buscar" autocomplete="on" id="qsearch__in" value="" /><button value="1" type="submit" title="Buscar">Buscar</button><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>            <div class="mobileTools">
                <form action="http://www.proyecto-ciaa.com.ar/devwiki/doku.php" method="get" accept-charset="utf-8"><div class="no"><input type="hidden" name="id" value="desarrollo:firmware:generador" /><select name="do" class="edit quickselect" title="Herramientas"><option value="">Herramientas</option><optgroup label="Herramientas de la página"><option value="">Ver página</option><option value="revisions">Revisiones antiguas</option><option value="backlink">Enlaces a esta página</option></optgroup><optgroup label="Herramientas del sitio"><option value="recent">Cambios recientes</option><option value="media">Administrador de Ficheros</option><option value="index">Índice</option></optgroup><optgroup label="Herramientas de usuario"><option value="login">Conectarse</option></optgroup></select><button type="submit">&gt;</button></div></form>            </div>
            <ul>
                <li class="action recent"><a href="./doku.php%3Fid=desarrollo:firmware:generador&amp;do=recent.html" title="Cambios recientes [r]" rel="nofollow" accesskey="r">Cambios recientes</a></li><li class="action media"><a href="./doku.php%3Fid=desarrollo:firmware:generador&amp;do=media&amp;ns=desarrollo:firmware.html" title="Administrador de Ficheros" rel="nofollow">Administrador de Ficheros</a></li><li class="action index"><a href="./doku.php%3Fid=desarrollo:firmware:generador&amp;do=index.html" title="Índice [x]" rel="nofollow" accesskey="x">Índice</a></li>            </ul>
        </div>

    </div>

    <!-- BREADCRUMBS -->
            <div class="breadcrumbs">
                                        <div class="trace"><span class="bchead">Traza:</span> <span class="bcsep">•</span> <bdi><a href="./doku.php%3Fid=desarrollo:firmware:0.4.0.html"  class="breadcrumbs" title="desarrollo:firmware:0.4.0">0.4.0</a></bdi> <span class="bcsep">•</span> <bdi><a href="./doku.php%3Fid=desarrollo:firmware:0.5.0.html"  class="breadcrumbs" title="desarrollo:firmware:0.5.0">0.5.0</a></bdi> <span class="bcsep">•</span> <bdi><a href="./doku.php%3Fid=desarrollo:firmware:porting.html"  class="breadcrumbs" title="desarrollo:firmware:porting">porting</a></bdi> <span class="bcsep">•</span> <bdi><a href="./doku.php%3Fid=desarrollo:firmware:bootloader.html"  class="breadcrumbs" title="desarrollo:firmware:bootloader">bootloader</a></bdi> <span class="bcsep">•</span> <bdi><a href="./doku.php%3Fid=desarrollo:firmware:uncrustify.html"  class="breadcrumbs" title="desarrollo:firmware:uncrustify">uncrustify</a></bdi> <span class="bcsep">•</span> <bdi><a href="./doku.php%3Fid=desarrollo:firmware:proceso:criterio_branches.html"  class="breadcrumbs" title="desarrollo:firmware:proceso:criterio_branches">criterio_branches</a></bdi> <span class="bcsep">•</span> <bdi><a href="./doku.php%3Fid=desarrollo:firmware:code_freeze.html"  class="breadcrumbs" title="desarrollo:firmware:code_freeze">code_freeze</a></bdi> <span class="bcsep">•</span> <bdi><a href="./doku.php%3Fid=desarrollo:firmware:firmware_layers.html"  class="breadcrumbs" title="desarrollo:firmware:firmware_layers">firmware_layers</a></bdi> <span class="bcsep">•</span> <bdi><a href="./doku.php%3Fid=desarrollo:firmware:coverage.html"  class="breadcrumbs" title="desarrollo:firmware:coverage">coverage</a></bdi> <span class="bcsep">•</span> <span class="curid"><bdi><a href="./doku.php%3Fid=desarrollo:firmware:callback.html"  class="breadcrumbs" title="desarrollo:firmware:callback">callback</a></bdi></span></div>
                    </div>
    
    <hr class="a11y" />
</div></header><!-- /header -->

        <div class="wrapper group">

            
            <!-- ********** CONTENT ********** -->
            <main id="dokuwiki__content"><div class="pad group">
                
                <div class="pageId"><span>desarrollo:firmware:generador</span></div>

                <div class="page group">
                                                            <!-- wikipage start -->
                    
<p>
Esta página es de solo lectura. Puedes ver la fuente pero no puedes cambiarla. Pregunta a tu administrador si crees que esto es incorrecto.
</p>
<div class="editBox" role="application"><div class="toolbar group"><div id="tool__bar" class="tool__bar"></div></div><div id="draft__status" class="draft__status"></div><form id="dw__editform" action="./doku.php%3Fid=desarrollo:firmware:generador&amp;do=edit.html" method="post" accept-charset="utf-8" class="doku_form"><input type="hidden" name="sectok" value="" /><input type="hidden" name="id" value="desarrollo:firmware:generador" /><input type="hidden" name="rev" value="0" /><input type="hidden" name="date" value="0" /><input type="hidden" name="prefix" value="." /><input type="hidden" name="suffix" value="" /><input type="hidden" name="changecheck" value="eb3640f24bbb8c40b97b5a10d05de363" /><input type="hidden" name="target" value="section" /><textarea name="wikitext" type="textarea" dir="auto" tabindex="1" readonly="readonly" cols="80" rows="10" id="wiki__text" class="edit">====== Generador de archivo OIL ======

&lt;note important&gt;
En construcción&lt;/note&gt;

===== Qué es OIL?  (Por si no está en otro lado) =====


*) xxx
El propósito del generador es producir archivos de encabezados .h y .c a partir de unos templates de C con php embebido que se ejectua según unos archivos configuración .oil y .oilx.



===== Arquitectura =====

Diagrama de clases


  +---+
  |Log|
  +---+
    ^
    |  
  +------------+          +------+
  |OilGenerator|---------&gt;|Helper|
  +------------+          +------+  
    |       |
    |       v
    |    +---------+       +---------+
    |    |OilConfig|------&gt;|OilParser|
    |    +---------+       +---------+
    |
    |   +------------+
    +--&gt;|OutputWriter|
        +------------+
               A                                    (A = Herencia) 
               |                                    (^v&lt;&gt; = Uso o composición)
        +------+-------+       
        |              |
  +----------+   +------------+
  |FileWriter|   |StdoutWriter|
  +----------+   +------------+
  

Diagrama de componentes


   +-----------+          +----------+          +-------------+
   |+------------+        |+-----------+        |+--------------+
   ||+-------------+      ||+------------+      ||+---------------+
   +||  configs    |      +||  helpers   |      +||   templates   |
    +|(.oil|.olix) |       +|   (.php)   |       +|(.c.php|.h.php)|
     +-------------+        +------------+        +---------------+
           |                     |                     |
           +----------------+    |   +-----------------+
                            |    |   |
                            v    v   v
  +--------------+        +------------+
  | command line |-------&gt;| generator  |
  | options and  |        +------------+
  | defines      |               |
  +--------------+               v 
                           +----------+
                           |+-----------+
                           +|+------------+
                            +|  salidas   |
                             |  (.h|.c)   |
                             +------------+

===== Detalles =====

generator.php contruye el objeto OilGenerator dándole un tipo de salida.

OilGenerator procesa los argumentos, verifica la existencia de las entradas y salidas, carga los helpers declarados, parsea los oil/oilx e incluye cada template, que utilizando los métodos disponibles genera cada archivo objetivo, según estas reglas de nombres (completar)

===== Interrelación de templates =====

La implementación original permitía la comunicación directa entre templates, o sea, estos se cargaban en el mismo scope. 

   clase OilGenerator
       metodo run()                           \
           para cada template en templates    |
               activar buffer de salida       + scope original
               evaluar template               |
               salvar buffer de salida        /   


Según #386 y la cadena &quot;Consulta acerca de aislación de templates de OilGenerator&quot;, la nueva implementación encapsulará las llamadas impidiendo efectos colaterales entre templates.


   clase OilGenerator
       metodo run()
           para cada template en templates
               activar buffer de salida
               llamada a metodo de objeto encapsulador   
                   evaluar template                      } scope actual
               salvar buffer de salida              

Si hubiera necesidad concreta de que haya alguna comunicación, implementaremos algún mecanismo explícito.


Con respecto a la invocación de helpers hay permanentes y efímeros. Los primeros son los cargados por linea de comando disponibles para todos los templates. Los efímeros los que se cargan en cada template.


Carga efímera de Helper con invocación en el template:

&lt;code php&gt;
$this-&gt;loadHelper(&quot;modules/rtos/gen/ginc/HelperX.php&quot;);
&lt;/code&gt;

Carga permanente por linea de comando:

&lt;code bash&gt;
-H modules/rtos/gen/ginc/HelperX.php
&lt;/code&gt;

La inclusión de helpers brinda acceso a los métodos de un objeto Helper:

&lt;code php&gt;
$this-&gt;helper-&gt;multicore-&gt;getLocalList(&quot;/OSEK&quot;, &quot;TASK&quot;);
&lt;/code&gt;

Aún no está definido el comportamiento ante múltiples cargas del mismo Helper. El resultado es que cada carga pisa a la anterior y podría ser el comportamiento final deseado. Veremos.

Para la migración hay que estar atentos a la aparición en el log de mensajes de warning o error referidos a variables indefinidas como $os, $priority y $tasks. Se soluciona copiando del template anterior que funcione y tenga las llamadas tipo 

&lt;code php&gt;
$tasks = $this-&gt;helper-&gt;multicore-&gt;getLocalList(&quot;/OSEK&quot;, &quot;TASK&quot;);
&lt;/code&gt;

Por ahora hay que repetir en cada template todas las llamadas. Si surge un patrón de uso, veremos de refactorizar.

Por el momento no nos preocuparemos por la falta de performance de esta solución, ya que no es una operación frecuente.

===== Ciclo de vida de un Helper =====

El ciclo sería primero definir las funciones propias de un template en el mismo. Si hay oportunidad de reutilización, va a un Helper local al módulo o proyecto. Si su utilidad es transversal, pasaría a ... la carpeta de Helpers del generador o alguna ubicación común a definir.

TODO: los Helpers deben proveer un método de ayuda e implementar en algún lado que ante ... --help-helpers se exploren los Helpers y se muestre esa ayuda. Esto implica que debe existir la clase AbstractHelper.

===== Opciones =====

Las opciones se pueden consultar con 
&lt;code bash&gt;
php modules/rtos/generator/generator.php --help

php generator.php [-l] [-h] [--cmdline] \
     [-b path]\
     [-Ddef[=definition]] \
     -c &lt;CONFIG_1&gt; [&lt;CONFIG_N&gt;] \
     -o &lt;OUTPUTDIR&gt; \
     -t &lt;TEMPLATE_1&gt; [&lt;TEMPLATE_N&gt;] \
     -[ -H &lt;HELPER_1&gt; [HELPER_N]]
   
     -c   indicate the configuration input files
     -o   output directory
     -t   indicates the templates to be processed
  optional parameters:
     -b   relative base path (default &quot;/templates/&quot;)
     -H   load helpers
     -h   display this help
     -l   displays a short license overview
     -D   defines
     --cmdline print the command line
&lt;/code&gt;

  
StdoutWriter existe a fines de testeo y si mal no recuerdo, no funciona bien por el hecho de estar usando ob_*.

=== Elección del lenguaje ===

Se ha elegido php por que aunque es un lenguaje completo, está pensado para templating. Se pudo haber usado django, twig o similares, pero en esos casos había que incorporar un lenguaje y un sistema de templating.

Los programas php estaban pensados originalmente para intercalar código con el formato html, al igual que jsp (no?). Esto viene muy bien pues permite escribir archivos .h o .c con partes estáticas y resolver mediante código las partes dinámicas, provenientes de los .oil con ayuda de los helpers.



Una particularidad muy especial es que existen funciones de buffering (ob_*) para manipular el stdout, lo que permite intercalar código C estático con el código embebido en php con extrema sencillez.

Estas piezas de código, se ejecutan en el contexto de una llamada a un método de un objeto OilGenerator, que previamente ha cargado la configuración y mediante una serie de métodos disponibles xxxxx



===== Testing =====
Se está utilizando test unitario con phpunit y funcional con shunit...


===== ¿Cómo hago para... =====




==== ... hacer un template? =====

Copiar el ejemplo para tener la licencia

El template consta de dos partes intercaladas, las estáticas y las dinámicas

Las estáticas son las que van de modo incondicional y fijo, como la licencia.

Las dinámicas son las que dependen de distintos factores variables como:
  * Configuración OIL
  * Defines pasados por linea de comando

Lo contenidos dinámicos pueden ser tan sencillos como mostrar un define:

&lt;? 

la ... de un componente

...


o la ...

...

Los loops tienen contadores implícitos que se pueden aprovechar para simplificar el código.

&lt;code php&gt;
foreach ($coleccion as $contador=&gt;$elemento) {
   print(&quot;elemento: &quot; . $elemento-&gt;nombre . &quot; posición: &quot; . $contador);
}
&lt;/code&gt;

producirá:

&lt;code&gt;
elemento nombreUno posición: 0
elemento nombreDos posición: 1
elemento nombreTres posición: 2
&lt;/code&gt;

y es equivalente a:

&lt;code php&gt;
$contador = 0;
foreach ($coleccion as $elemento) {
   print(&quot;elemento: &quot; . $elemento-&gt;nombre . &quot; posición: &quot; . $contador++);
}
&lt;/code&gt;

o tambien a

&lt;code php&gt;
for($contador = 0; $contador &lt; $coleccion.size(); $contador++) {
   print(&quot;elemento: &quot; . $elemento-&gt;nombre . &quot; posición: &quot; . $contador++);
}
&lt;/code&gt;






Los recursos disponibles en el contexto del template son
  * log
  * config
  * helper

y se acceden mediante &lt;code php&gt;$this-&gt;&lt;/code&gt;

en particular, la clase Log provée:

&lt;code php&gt;
$this-&gt;log-&gt;info($msg);
$this-&gt;log-&gt;warn($msg);
$this-&gt;log-&gt;error($msg);
&lt;/code&gt;

En caso de cancelar, por ahora hay que tirar una excepción usando la OilGeneratorException

&lt;code php&gt;
throw new OilGeneratorException($msg, $exitCode);
&lt;/code&gt;



==== ... para utilizar unos templates con algunos config y algunos con otros? ====

&lt;note important&gt;ver si es un escenario factible y reformular&lt;/note&gt;

</textarea><div id="wiki__editbar" class="editBar"><div id="size__ctl"></div></div></form></div>
                    <!-- wikipage stop -->
                                    </div>

                <div class="docInfo"><bdi>desarrollo/firmware/generador.txt</bdi> · Última modificación: 2016/07/20 02:52 por <bdi>cpantelides</bdi></div>

                
                <hr class="a11y" />
            </div></main><!-- /content -->

            <!-- PAGE ACTIONS -->
            <nav id="dokuwiki__pagetools" aria-labelledby="dokuwiki__pagetools__heading">
                <h3 class="a11y" id="dokuwiki__pagetools__heading">Herramientas de la página</h3>
                <div class="tools">
                    <ul>
                        <li class="show"><a href="http://www.proyecto-ciaa.com.ar/devwiki/doku.php?id=desarrollo:firmware:generador&amp;do=" title="Ver página [v]" rel="nofollow" accesskey="v"><span>Ver página</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M13 9h5.5L13 3.5V9M6 2h8l6 6v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4c0-1.11.89-2 2-2m9 16v-2H6v2h9m3-4v-2H6v2h12z"/></svg></a></li><li class="revs"><a href="./doku.php%3Fid=desarrollo:firmware:generador&amp;do=revisions.html" title="Revisiones antiguas [o]" rel="nofollow" accesskey="o"><span>Revisiones antiguas</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M11 7v5.11l4.71 2.79.79-1.28-4-2.37V7m0-5C8.97 2 5.91 3.92 4.27 6.77L2 4.5V11h6.5L5.75 8.25C6.96 5.73 9.5 4 12.5 4a7.5 7.5 0 0 1 7.5 7.5 7.5 7.5 0 0 1-7.5 7.5c-3.27 0-6.03-2.09-7.06-5h-2.1c1.1 4.03 4.77 7 9.16 7 5.24 0 9.5-4.25 9.5-9.5A9.5 9.5 0 0 0 12.5 2z"/></svg></a></li><li class="backlink"><a href="./doku.php%3Fid=desarrollo:firmware:generador&amp;do=backlink.html" title="Enlaces a esta página" rel="nofollow"><span>Enlaces a esta página</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M10.59 13.41c.41.39.41 1.03 0 1.42-.39.39-1.03.39-1.42 0a5.003 5.003 0 0 1 0-7.07l3.54-3.54a5.003 5.003 0 0 1 7.07 0 5.003 5.003 0 0 1 0 7.07l-1.49 1.49c.01-.82-.12-1.64-.4-2.42l.47-.48a2.982 2.982 0 0 0 0-4.24 2.982 2.982 0 0 0-4.24 0l-3.53 3.53a2.982 2.982 0 0 0 0 4.24m2.82-4.24c.39-.39 1.03-.39 1.42 0a5.003 5.003 0 0 1 0 7.07l-3.54 3.54a5.003 5.003 0 0 1-7.07 0 5.003 5.003 0 0 1 0-7.07l1.49-1.49c-.01.82.12 1.64.4 2.43l-.47.47a2.982 2.982 0 0 0 0 4.24 2.982 2.982 0 0 0 4.24 0l3.53-3.53a2.982 2.982 0 0 0 0-4.24.973.973 0 0 1 0-1.42z"/></svg></a></li><li class="top"><a href="./doku.php%3Fid=desarrollo:firmware:generador&amp;do=edit.html#dokuwiki__top" title="Volver arriba [t]" rel="nofollow" accesskey="t"><span>Volver arriba</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg></a></li>                    </ul>
                </div>
            </nav>
        </div><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<footer id="dokuwiki__footer"><div class="pad">
    
    <div class="buttons">
                <a href="https://www.dokuwiki.org/donate" title="Donate" target="_blank"><img
            src="lib/tpl/dokuwiki/images/button-donate.gif" width="80" height="15" alt="Donate" /></a>
        <a href="https://php.net" title="Powered by PHP" target="_blank"><img
            src="lib/tpl/dokuwiki/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5" target="_blank"><img
            src="lib/tpl/dokuwiki/images/button-html5.png" width="80" height="15" alt="Valid HTML5" /></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" target="_blank"><img
            src="lib/tpl/dokuwiki/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>
        <a href="https://dokuwiki.org/" title="Driven by DokuWiki" target="_blank"><img
            src="lib/tpl/dokuwiki/images/button-dw.png" width="80" height="15"
            alt="Driven by DokuWiki" /></a>
    </div>

    </div></footer><!-- /footer -->
    </div></div><!-- /site -->

    <div class="no"><img src="http://www.proyecto-ciaa.com.ar/devwiki/lib/exe/taskrunner.php?id=desarrollo%3Afirmware%3Agenerador&amp;1700036497" width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no"></div></body>
</html>
